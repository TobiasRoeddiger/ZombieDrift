<html>
    <head>
    	<link rel="stylesheet" type="text/css" href="css/style.css">
    	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    	<script src="/socket.io/socket.io.js"></script>
    	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.4.8/phaser.min.js"></script>
    </head>
    <body id="body">
    	<div id="scoreWindow">
            <div id="Score"><b>Score:</b> 0</div>
        </div>
        
        <div id="debugWindow">
            <div id="Connected"><b>Connected:</b> True</div>
            <div id="PeerId"><b>Peer ID:</b> None</div>
            <div id="DataMonitor"><b>Connected Clients:</b> None</div>
        	<!-- <div id="xValue"><b>X:</b> None</div> --!>
            <div id="yValue"><b>Y:</b> None</div>
            <div id="fps"><b>FPS:</b> 0</div>
            <!-- <div id="zValue"><b>Z:</b> None</div> --!>
        </div>

        <button id="debugButton" onclick="toggleDebug()">Turn Debug Off</button>
        
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script type="text/javascript">
        		var socket = io('http://mobilecomputingwebsite.azurewebsites.net');
        		
                var isDebugOn = false;
                var debugButton = document.getElementById("debugButton");
                var debugWindow = document.getElementById("debugWindow");
                toggleDebug();

                function toggleDebug() {
                    if (isDebugOn) {
                        debugWindow.style.visibility= 'hidden';
                        debugButton.innerHTML = "Turn Debug On";
                        debugButton.style.color = "black";
                        isDebugOn = false;
                    } else {
                        debugWindow.style.visibility= 'visible';
                        debugButton.innerHTML = "Turn Debug Off"
                        debugButton.style.color = "red";
                        isDebugOn = true;
                    }
                }
                var connectedInfo = document.getElementById("Connected");

                var peerIdLabel = document.getElementById("PeerId");
                var id = "";
                peerIdLabel.innerHTML = "<b>RoomID:</b> " + makeid();
                function makeid()
				{
				    var text = "";
				    var possible = "0123456789";
				
				    for( var i=0; i < 6; i++ )
				        text += possible.charAt(Math.floor(Math.random() * possible.length));
					id = text;
				    return text;
				}
				
				var connectedInfo = document.getElementById("DataMonitor");
				socket.on('connect', function() {
  					socket.emit('addRoom', { roomId: id, desktopClientId: socket.id});
				});
				
				socket.on('movementData', function(data) {
					consologe.log(data.x);
				});
				
				socket.on('newClient', function(data) {
					console.log(data.id);
					document.getElementById('DataMonitor').innerHTML = "<b>Connected Clients:</b> " + data.id;
				});
				
				var accY = 0.0;
				var accY2 = 0.0;
				var isAccelerating = false;
				var isAcceleratingRemote = false;
				var isAcceleratingTruck2 = false;
				socket.on('newAccelerometerData', function(data) {
					//console.log(data.x);
					//document.getElementById("xValue").innerHTML = "<b>X:</b> " + data.x;
					document.getElementById("yValue").innerHTML = "<b>Y:</b> " + data.y;
					//document.getElementById("zValue").innerHTML = "<b>Z:</b> " + data.z;
					
					accY = data.y;
				});
				
				socket.on('accelerationEvent', function(data) {
					isAcceleratingRemote = data;
				});
				
				
				//game implementation
				var width = window.innerWidth;
				var height = window.innerHeight;
				
				var game = new Phaser.Game(width, height, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render });

				function preload() {
					game.load.image('truck', 'assets/truck.png');
					game.load.image('truck2', 'assets/truck2.png');
					
					game.load.image('background', 'assets/background.png');
					
					game.load.image('tree3', 'assets/tree3.png');
					game.load.image('tree4', 'assets/tree4.png');
					game.load.image('tree5', 'assets/tree5.png');
					game.load.image('tree6', 'assets/tree6.png');
					game.load.image('tree7', 'assets/tree7.png');
					game.load.image('tree8', 'assets/tree8.png');
					game.load.image('tree9', 'assets/tree9.png');
					
					game.load.image('blood', 'assets/blood.png');
					
					game.load.spritesheet('zombieSimple', 'assets/zombies/simple/zombie_sprites.png', 48, 48, 8);
					
					game.time.advancedTiming = true;
				}

				var truck;
				var truck2;
				var background;
				var zombies;
				var worldWidth = 2667;
				var worldHeight = 1600;
				var bloodEmitter;
				var zombieCollisionGroup;
				var playerCollisionGroup;
				function create() {
					//create and add sprites
					background = game.add.tileSprite(0, 0, 2667, 1600, 'background');
					
					
					//enable and configure physics
					game.physics.startSystem(Phaser.Physics.P2JS);
					game.physics.p2.setImpactEvents(true);
					
					game.world.setBounds(0, 0, worldWidth, worldHeight);
					
					
					
					var trees = Math.floor((Math.random() * 40) + 10);

    				zombieCollisionGroup = game.physics.p2.createCollisionGroup();
    				playerCollisionGroup = game.physics.p2.createCollisionGroup();

					zombies = game.add.group();
					for (var i = 0; i < 30; i++) {
						var zombie = zombies.create(200 + Math.floor(Math.random() * (worldWidth -  200)),200 + Math.floor(Math.random() * (worldHeight -  200)), 'zombieSimple');
        				game.physics.p2.enable(zombie, false);
        				zombie.body.setCircle(16, 4, 5, 0);
						zombie.body.setCollisionGroup(zombieCollisionGroup);
						zombie.body.collides([zombieCollisionGroup, playerCollisionGroup]);
						zombie.animations.add('walk');
						zombie.body.damping = 0.95;
						zombie.animations.play('walk', 7, true);
						zombie.body.mass = 0.1;
					}
					
					truck = game.add.sprite(128, 128, 'truck');
					game.physics.p2.enable(truck);
					truck.body.damping = 0.95;
					game.camera.follow(truck);
					truck.body.setCollisionGroup(playerCollisionGroup);
					truck.body.collides(zombieCollisionGroup, killZombie, this);
					truck.body.collides(playerCollisionGroup);
					
					truck2 = game.add.sprite(180, 128, 'truck2');
					game.physics.p2.enable(truck2);
					truck2.body.damping = 0.95;
					truck2.body.setCollisionGroup(playerCollisionGroup);
					truck2.body.collides(zombieCollisionGroup, killZombie, this);
					truck2.body.collides(playerCollisionGroup);
					
					
					for (var j = 0; j < trees; j++) {
						var treeType = Math.floor((Math.random() * 6) + 3);
						game.add.sprite(200 + Math.floor(Math.random() * (worldWidth -  200)),200 + Math.floor(Math.random() * (worldHeight -  200)), 'tree' + treeType.toString());
					}
					
					game.physics.p2.updateBoundsCollisionGroup();
					
					bloodEmitter = game.add.emitter(0, 0, 100);
					bloodEmitter.makeParticles('blood');
				}
				
				var score = 0;
				var scoreField = document.getElementById("Score");
				function killZombie(truck, zombie) {
					var minSpeedToDie = 15;
					if (!(truck.velocity.x > minSpeedToDie || truck.velocity.y > minSpeedToDie || truck.velocity.x < -minSpeedToDie || truck.velocity.y < -minSpeedToDie)) {
						return;
					} 
					
					zombie.static = true;
					zombie.sprite.loadTexture('blood');
					zombie.moves = false;
					zombie.setCircle(0, 0, 0, 0);
					zombie.velocity.x = 0;
					zombie.velocity.y = 0;
					zombie.fixedRotation = true;
				    zombie.sprite.sendToBack();
				    
				    score += 1;
                	scoreField.innerHTML = "<b>Score:</b> " + score;
                	
                	var timer = new Phaser.Timer(this, true);
                	game.time.events.add(2000, destroyZombieBlood, this, zombie.sprite);
				}
				
				function destroyZombieBlood(zombie) {
					//zombie.kill();
				}
					
				
				var currentSpeed = 0;
				var willAddNewZombies = false;
				var scale = 1.0;
				function update() {
					
					var x = truck.x - truck2.x;
					var y = truck.y - truck2.y;
					
					if (!truck2.inCamera) {
						scale -= 0.001;
						game.world.scale.set(scale);
					}
					

					if (!willAddNewZombies) {
						game.time.events.add(Math.floor(Math.random() * 20000 + 1000), spawnZombies, this);
						willAddNewZombies = true;
					}
					
					if (isAccelerating || isAcceleratingRemote) {
						truck.body.thrust(1000);
    				}
    				
    				if (isAcceleratingTruck2) {
						truck2.body.thrust(1000);
    				}
				
    				if (game.input.keyboard.isDown(Phaser.Keyboard.UP)) {
						isAccelerating = true;
    				} else {
    				    isAccelerating = false;	
    				}
    				
    				if (game.input.keyboard.isDown(Phaser.Keyboard.W)) {
						isAcceleratingTruck2 = true;
    				} else {
    				    isAcceleratingTruck2 = false;	
    				}
					
					
    				if (truck.body.velocity.x !== 0 || truck.body.velocity.y !== 0) {
    				    if (game.input.keyboard.isDown(Phaser.Keyboard.LEFT)) {
    				    	accY = 3.0;
    				    } else if (game.input.keyboard.isDown(Phaser.Keyboard.RIGHT)) {
    				    	accY = -3.0;
    				    } else if (!isAcceleratingRemote) {
    				    	accY = 0.0;
    				    }
    				    
    					if (accY > 0.5 || game.input.keyboard.isDown(Phaser.Keyboard.LEFT)) {
    						truck.body.rotateLeft(15 * accY);
    					} else if (accY < -0.5 || game.input.keyboard.isDown(Phaser.Keyboard.RIGHT)) {
    						truck.body.rotateLeft(15 * accY);
    					} else {
    						truck.body.setZeroRotation();
    					}
    				} else {
    					truck.body.setZeroRotation();
    				}
    				
    				if (truck2.body.velocity.x !== 0 || truck2.body.velocity.y !== 0) {
    				    if (game.input.keyboard.isDown(Phaser.Keyboard.A)) {
    				    	accY2 = 3.0;
    				    } else if (game.input.keyboard.isDown(Phaser.Keyboard.D)) {
    				    	accY2 = -3.0;
    				    } else if (!isAcceleratingRemote) {
    				    	accY2 = 0.0;
    				    }
    				    
    					if (accY2 > 0.5 || game.input.keyboard.isDown(Phaser.Keyboard.A)) {
    						truck2.body.rotateLeft(15 * accY2);
    					} else if (accY2 < -0.5 || game.input.keyboard.isDown(Phaser.Keyboard.D)) {
    						truck2.body.rotateLeft(15 * accY2);
    					} else {
    						truck2.body.setZeroRotation();
    					}
    				} else {
    					truck2.body.setZeroRotation();
    				}
    				
    				constrainVelocity(truck, 18);
    				constrainVelocity(truck2, 18);
    				
    				zombies.forEachAlive(moveZombie,this);
    				
    				document.getElementById("fps").innerHTML = "<b>FPS:</b> " + game.time.fps;
				}
				
				function spawnZombies() {
					console.log("spawning zombies");
					for (var i = 0; i < 30; i++) {
						var zombie = zombies.create(128 + Math.floor(Math.random() * (worldWidth -  128)),128 + Math.floor(Math.random() * (worldHeight -  128)), 'zombieSimple');
        				game.physics.p2.enable(zombie, false);
        				zombie.body.setCircle(16, 4, 5, 0);
						zombie.body.setCollisionGroup(zombieCollisionGroup);
						zombie.body.collides([zombieCollisionGroup, playerCollisionGroup]);
						zombie.animations.add('walk');
						zombie.body.damping = 0.95;
						zombie.animations.play('walk', 7, true);
						zombie.body.mass = 0.1;
					}
					willAddNewZombies = false;
				}
				
				function moveZombie(zombie) { 
					if (zombie.body.static) {
						return;
					}
					
					var distanceToTruck1 = Math.sqrt((zombie.x-truck.x)*(zombie.x-truck.x)+(zombie.y-truck.y)*(zombie.y-truck.y));
					var distanceToTruck2 = Math.sqrt((zombie.x-truck2.x)*(zombie.x-truck2.x)+(zombie.y-truck2.y)*(zombie.y-truck2.y));
					
					if (distanceToTruck1 > distanceToTruck2) {
						accelerateToObject(zombie,truck2,20);
					} else {
						accelerateToObject(zombie,truck,20);
					}
     				
     				constrainVelocity(zombie, 8);
				}
				
				function accelerateToObject(obj1, obj2, speed) {
    				if (typeof speed === 'undefined') { speed = 60; }
    				var angle = Math.atan2(obj2.y - obj1.y, obj2.x - obj1.x);
    				obj1.body.rotation = angle + game.math.degToRad(90);  // correct angle of angry bullets (depends on the sprite used)
    				obj1.body.force.x = Math.cos(angle) * speed;    // accelerateToObject 
    				obj1.body.force.y = Math.sin(angle) * speed;
				}
				
				function render() {
				            
				}
				
				function constrainVelocity(sprite, maxVelocity) {  
					var body = sprite.body;
					var angle, currVelocitySqr, vx, vy;  
					
					vx = body.data.velocity[0];  
					vy = body.data.velocity[1];  
					currVelocitySqr = vx * vx + vy * vy;  
					
					if (currVelocitySqr > maxVelocity * maxVelocity) {    
						angle = Math.atan2(vy, vx);    
						vx = Math.cos(angle) * maxVelocity;    
						vy = Math.sin(angle) * maxVelocity;    
						body.data.velocity[0] = vx;    
						body.data.velocity[1] = vy;    
					}
				};
        </script>
    </body>
</html>